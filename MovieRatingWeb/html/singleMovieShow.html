<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Ratings</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="movieRating.css">
   <style>
    .singleMovieBox{
        background-color: black;
        width: 600px;
        padding: 20px;
        box-shadow: 0 0 3px 2px rgb(138, 136, 136);
    }
    .movieImage{
        width: 100%;
        height: 300px;
        border: 1px solid white;
    }
    .movieImage img{
        width: 100%;
        height: 100%;
    }
    #movieDescription{

        text-wrap: wrap;
    }
    #singleMovieDetails{
        color: white;
        padding-top: 10px;
    }
    .commentBox{
        display: flex;
        gap: 5px;
        flex-direction: column;
        padding: 10px 20px;
        width: 100%;
        background-color: white;
        height: 200px;
        overflow-y: auto;
        color: black;
        border-radius: 7px;
    }
   
    .eachComment p {
        padding: 0;
        margin: 0;
        width: max-content;
    }
    .eachComment:nth-child(odd) span{
        color:red;
        
    }
    .eachComment:nth-child(even) span{
        color:blue;
    }
    .title{
        color: rgb(255, 208, 0);
    }
    .userCommentBox{
        width: 350px;
        padding: 20px;
        background-color: rgb(244, 212, 31);
    }
    #movieContentBox{
        display: flex;
        align-items: start;
        column-gap: 20px;
    }
    #floatingTextarea{
        height: 160px;
    }
   </style>
</head>
<body>
    <div class="wrapper">
        <nav class="navbar navbar-expand-lg nav">
            <div class="container-fluid mx-5">
              <a class="navbar-brand" href="#">Movie Rating</a>
              <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
              </button>
              <div class="collapse navbar-collapse" id="navbarSupportedContent">
               
                <ul class="navbar-nav  mb-2 mb-lg-0 ms-auto">
                  
                  <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle lh-base text-white" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                      <i class="bi bi-person-circle  me-2"></i><span id="loginUser"></span>
                    </a>
                    <ul class="dropdown-menu">
                     
                      <li><a class="dropdown-item" href="#" onclick="logout()">Log Out</a></li>
                    </ul>
                  </li>
                  
                </ul>
                
              </div>
            </div>
          </nav>
          <div class="main-container">
            <div class="mainContainer-left">
                <ul class="sideMenu">
                    <li><a href="dashboard.html" class="sideMenu-link">Home</a></li>
                  <li><a href="catagoryShow.html?catagory=Top Rated" class="sideMenu-link">Top Rated Movies</a></li>
                  <li><a href="catagoryShow.html?catagory=blockBuster" class="sideMenu-link">Block Buster Movies</a></li>
                  <li><a href="catagoryShow.html?catagory=Top Movies" class="sideMenu-link">Top Popular Movies</a></li>
                 </ul>
            </div>
            <div class="mainContainer-right" id="MainRightBox">
              

              <!-- top movies -->
              <div class="topMovieBox">                
                <div class="movieContentBox">
                   <div id="movieContentBox">
                    <div class="singleMovieBox">
                        <div class="movieImage">
                            <img src="https://images.pexels.com/photos/236047/pexels-photo-236047.jpeg?cs=srgb&dl=clouds-cloudy-countryside-236047.jpg&fm=jpg" alt="">
                        </div>
                        <div id="singleMovieDetails">
                            <div class="MovieName "><span class="title" >Movie Name</span> : THunivu</div>
                            <div class="MovieRating "><span class="title" >Movie Rating</span> : 8</div>
                            <div class="MovieReleseDate"><span class="title">Release Date</span> : 2021</div>
                            <div class="MovieDirector"><span class="title">Director</span> : Rajkumar</div>
                            <div class="MovieDesc">
                                <h4>Description</h4>
                                <p id="movieDescription">Lorem ipsum dolor sit amet consectetur, adipisicing elit. Aliquid quod facere expedita corporis laudantium, excepturi dolor omnis aut neque est ducimus adipisci perspiciatis placeat labore a nam cum, ipsam voluptatibus.</p>
                            </div>
                            <!-- comments section -->
                            <div>
                                <h5>Comments</h5>
                                <div class="commentBox" id="commentBox">
                                    <div class="eachComment">
                                        <span>Rajkumar</span>
                                        <p>Good</p>
                                    </div>
                                    <div class="eachComment">
                                        <span>Rajkumar</span>
                                        <p>Good</p>
                                    </div>
                                    <div class="eachComment">
                                        <span>Rajkumar</span>
                                        <p>Good</p>
                                    </div>
                                    <div class="eachComment">
                                        <span>Rajkumar</span>
                                        <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Fugiat dolorem veritatis, hic est ad inventore dolorum possimus in quam accusantium. Molestias autem ad consectetur quae quam impedit tempore praesentium voluptatibus?</p>
                                    </div>
                                </div>
                            </div>
    
                        </div>
                       </div>
                   </div>
                   <!-- user Comment box -->
                   <div class="userCommentBox">
                    <div>                       
                        <h3 class="heading text-center">Add Comments</h3>            
                        <div class="mb-3">
                            <div id="msg"></div>
                            <input type="number" class="form-control" id="userRating" value="" placeholder="Enter Ratings" required >
                          </div>
                            <div class="form-floating">
                                <textarea class="form-control" placeholder="Leave a comment here" id="floatingTextarea"></textarea>
                                <label for="floatingTextarea">Comments</label>
                              </div> 
                          <input type="button" value="Submit" class="btn btn-success w-100 mt-3" onclick="commentSubmit()">
                    </div>
                   </div>

                  
                </div>
              </div>

              
            

            </div> 
            
          </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="loginUser.js"></script>
    <script>
        let currenturl = window.location.href
        let url = new URL(currenturl)
        let catagory = url.searchParams
        let index = catagory.get('i')
        let ExistMovieData = JSON.parse(localStorage.getItem('ExistMovieDetails'))
        let singleMoiveContentBox = document.getElementById('movieContentBox')
        let loggedUser = sessionStorage.getItem('loginUser')
        singleMoiveContentBox.innerHTML=`
        <div class="singleMovieBox">
                    <div class="movieImage">
                        <img src="${ExistMovieData[index].image}" alt="">
                    </div>
                    <div id="singleMovieDetails">
                        <div class="MovieName "><span class="title" >Movie Name</span> : ${ExistMovieData[index].mname}</div>
                        <div class="MovieRating "><span class="title" >Movie Rating</span> :<span id="movieRating" >${ExistMovieData[index].mrating}</span> </div>
                        <div class="MovieReleseDate"><span class="title">Release Year</span> : ${ExistMovieData[index].releaseYear}</div>
                        <div class="MovieDirector"><span class="title">Director</span> : ${ExistMovieData[index].Director}r</div>
                        <div class="MovieDesc">
                            <h4>Description</h4>
                            <p id="movieDescription">${ExistMovieData[index].Desc}</p>
                        </div>
                        <!-- comments section -->
                        <div>
                            <h5>Comments</h5>
                            <div class="commentBox" id="commentBox">
                                
                            </div>
                        </div>

                    </div>
                   </div>
        `
        
        
        // catagory movies shows
        let updateComments = () =>{
            let commentBox = document.getElementById('commentBox')
            commentBox.innerHTML = ''
            ExistMovieData[index].comments.map(comment=>{
                if(comment.userName==loggedUser){
                    comment.userComment.map(value=>{
                        commentBox.innerHTML+=`
                        <div class="eachComment loguserComment  text-end">
                            <span class="text-success">You</span>
                            <p class="w-100 text-end">${value}</p>
                        </div>                   
                        `
                    })
                }
                else{
                    comment.userComment.map(value=>{
                        commentBox.innerHTML+=`
                        <div class="eachComment px-2 loguserComment text-start">
                            <span>${comment.userName}</span>
                            <p>${value}</p>
                        </div>                   
                        `
                    })
                }
            })
        }
        updateComments()

        // check user commented or not 
        let userIsComment = () =>{
            let status = ExistMovieData[index].comments.filter(value=>{ return value.userName==loggedUser})
            console.log(status)
            if(status.length==0){
                document.getElementById('userRating').style.display = 'block'
            }
            else{
                document.getElementById('userRating').style.display = 'none'
            }
        }
       // userIsComment()

        let isUserCommentCheck = () =>{
            let status = ExistMovieData[index].comments.filter(value=>{ return value.userName==loggedUser})
            return status
           
        }
        let status = isUserCommentCheck()
        console.log(status)
        // check user given inputs are empty or not 
        let userInputCheck=()=>{
            let urating = document.getElementById('userRating').value
            let ucomment = document.getElementById('floatingTextarea').value
      
            if(ucomment.trim() == '')
            {
                return {status:true,msg:'Enter Your comments'}
            }
            else{
                return {status:false}
            }
        }

        // userComment store into localstorage and update in display
        let commentSubmit = () => {
            let urating = document.getElementById('userRating').value
            let ucomment = document.getElementById('floatingTextarea').value
            
            let checkUserInput = userInputCheck()
            if(checkUserInput.status  )
            {
                alert(checkUserInput.msg)
            }
            else{
                let isUserCommentlength = isUserCommentCheck()
                if(isUserCommentlength.length==0){
                    let newUserComment = {
                    userName :loggedUser,
                    userComment : [ucomment],
                    userRating : urating
                }

                // new rating store in ExistMovieData
                ExistMovieData[index].comments.push(newUserComment)
                }
                else{
                    ExistMovieData[index].comments.map(value=>{
                        if(value.userName==loggedUser){
                            value.userRating=urating
                            value.userComment.push(ucomment)
                        }
                    })
                }
                

                // calculate all user ratings
                let totalRating=ExistMovieData[index].comments.reduce((sum,rating)=>{return sum+=Number(rating.userRating)},0)
                       
                // find rating average and update rating into movierating
                ExistMovieData[index].mrating=(totalRating/ExistMovieData[index].comments.length).toFixed(1)
                document.getElementById('movieRating').innerText=ExistMovieData[index].mrating
                        
                localStorage.setItem('ExistMovieDetails',JSON.stringify(ExistMovieData))
                        
                // update current user comment into comment box
                updateComments()
                document.getElementById('userRating').value=''
                document.getElementById('floatingTextarea').value=''
                alert('Your Rating and Comment submitted')
                //userIsComment()
                }       
            
           
        }


       
    </script>
</body>
</html>